name: Changeset Check

on:
  pull_request:
    branches:
      - main

jobs:
  changeset-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if changeset is required
        id: check-skip
        run: |
          # PRì— 'skip-changeset' ë¼ë²¨ì´ ìˆëŠ”ì§€ í™•ì¸
          if [[ "${{ contains(github.event.pull_request.labels.*.name, 'skip-changeset') }}" == "true" ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "â­ï¸  Skipping changeset check due to 'skip-changeset' label"
            exit 0
          fi

          # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
          git fetch origin ${{ github.base_ref }}
          # main ë¸Œëœì¹˜ë¥¼ ë¡œì»¬ì— ëª…ì‹œì ìœ¼ë¡œ ìƒì„± (changeset statusë¥¼ ìœ„í•´ í•„ìš”)
          git fetch origin ${{ github.base_ref }}:refs/remotes/origin/${{ github.base_ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          # ë¬¸ì„œ, CI, ì„¤ì • íŒŒì¼ë§Œ ë³€ê²½ëœ ê²½ìš° ì²´í¬
          if echo "$CHANGED_FILES" | grep -qvE '^(\.github/|\.changeset/|\.vscode/|docs/|README\.md|LICENSE|\.gitignore|\.prettierrc|\.eslintrc|package\.json|tsconfig\.json|vite\.config\.ts)'; then
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ Source code changes detected - changeset required"
          else
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "â­ï¸  Only docs/config changes detected - skipping changeset check"
          fi

      - name: Setup pnpm
        if: steps.check-skip.outputs.skip != 'true'
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        if: steps.check-skip.outputs.skip != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        if: steps.check-skip.outputs.skip != 'true'
        run: pnpm install --frozen-lockfile

      - name: Check for changesets
        if: steps.check-skip.outputs.skip != 'true'
        run: |
          # .changeset ë””ë ‰í† ë¦¬ì— ìˆëŠ” .md íŒŒì¼ ê°œìˆ˜ í™•ì¸ (config.json, README.md ì œì™¸)
          CHANGESET_COUNT=$(find .changeset -name "*.md" ! -name "README.md" | wc -l)

          echo "Found $CHANGESET_COUNT changeset(s)"

          if [ "$CHANGESET_COUNT" -eq 0 ]; then
            echo "âŒ Error: No changeset found!"
            echo ""
            echo "Please add a changeset to describe your changes:"
            echo "  pnpm changeset"
            echo ""
            echo "This helps us maintain a proper changelog and version history."
            echo ""
            echo "If you believe this PR doesn't need a changeset (docs/config only),"
            echo "please add the 'skip-changeset' label to this PR."
            exit 1
          else
            echo "âœ… Changeset found!"
            echo ""
            echo "Changeset files:"
            find .changeset -name "*.md" ! -name "README.md" -exec echo "  - {}" \;
          fi

      - name: Validate changeset format
        if: steps.check-skip.outputs.skip != 'true'
        run: pnpm changeset status --since=origin/${{ github.base_ref }} --verbose
